# 現行アルゴリズム採用理由書

更新日: 2026-02-15

## 1. はじめに

本書は、現在採用されている**「カルマンフィルタ + EMA + デッドゾーン + 静止平均積算」**という4段階のアルゴリズム構成が、なぜ他の選択肢（単純平均など）よりも優れていると判断され、採用に至ったかの理由を説明する。

---

## 2. 求められる性能要件

本アプリケーション（高精度傾斜角センサー）には、相反する3つの要件がある。

1. **高安定性（静止時）**: 置いた時に数値がピタリと止まること。0.01度の桁がチラチラ変動（フリッカー）しないこと。
2. **高応答性（動作時）**: ユーザーが傾けた時、遅れなく数値が追従すること。ヌルヌルと動くこと。
3. **超高精度（計測時）**: 建設現場の机水平調整など、完全に静止させた状態では、さらに高い精度（±0.001度レベル）で確定値を出すこと。

---

## 3. 各処理の採用理由

### ① カルマンフィルタ (1D Kalman Filter)

**【役割】: 真値の推定とノイズ分離**

- **採用理由**:
  - 単純なローパスフィルタ（平均化）では、ノイズを消そうと強くかけると、実際の動きに対して「遅延（ラグ）」が大きくなる。
  - カルマンフィルタは「予測」と「観測」のバランスを動的に取るため、**「定常的なノイズは強力に抑えつつ、急な変動（意図的な動き）には比較的素早く反応する」** という特性がある。
  - これにより、静止時の安定性と動作時の追従性を両立させる基盤となる。

### ② 指数移動平均 (EMA: Exponential Moving Average)

**【役割】: 質感の演出（重み付け）**

- **採用理由**:
  - カルマンフィルタの出力は、数学的には正しいが、人間が見るとまだ「機械的で微少な振動」が残っていることがある。
  - EMAを薄く掛けることで、アナログ針のような**「質量のある物体が動くような滑らかさ」**を演出できる。
  - これにより、ユーザーに「安っぽいセンサー」ではなく「精密測定器」のような操作感を与えている。

### ③ デッドゾーン (Deadzone / Hysteresis)

**【役割】: 数値の「ロック」**

- **採用理由**:
  - 計算上の値が `0.001` 度でも変動すれば、デジタル表示は書き換わってしまう。
  - ユーザー心理として、静止させているつもりなのに数値が変わると「壊れているのか？」「水平が出ない」とストレスを感じる。
  - 変化量が一定以下の場合に値を**強制的に更新しない（前の値を維持する）**ことで、**「ピタリと止まった」**という安心感を提供する。これは物理的な気泡管水準器の「摩擦で止まる感じ」を模倣している。

### ④ 静止平均積算 (Static Average / Latch & Average) ⭐ 新規追加

**【役割】: 静止時の超高精度化**

- **採用理由**:
  - 上記①〜③の構成では、±0.005度程度の安定性が限界であった。
  - 建設現場での机の脚調整では、「完全に静止させた状態で、もう1桁高い精度が欲しい」という要求がある。
  - 静止状態を自動検出し、その間のデータを蓄積・平均化することで、サンプル数に比例してノイズが $\frac{1}{\sqrt{n}}$ で減衰する。
  - **「動いている時は機敏に、止まったら超高精度に」** という二面性を実現する。

---

## 4. 他の手法との比較（不採用理由）

| 手法 | 特徴 | 不採用の理由 |
| :--- | :--- | :--- |
| **単純移動平均 (SMA)** | 過去N点の平均 | ノイズを消すレベルまでNを増やすと、動き出しの反応が鈍くなり、操作感が「モッサリ」するため。 |
| **メディアンフィルタ** | 中央値 | スパイクノイズ（突発的な異常値）には強いが、連続的な振動ノイズに対しては数値が階段状に変化してしまい、滑らかさに欠けるため。 |
| **生データ (Raw)** | 加工なし | 値が暴れすぎて、0.01度の桁が判読不能になるため。 |
| **ZUPT** | ゼロ速度更新 | 静止平均積算と概念が類似するが、実装が複雑なわりに得られる効果が同等であるため。 |

---

## 5. 結論

現在の構成は、以下のベストバランスを達成するために設計されている。

> **「カルマン」でノイズの本質を取り除き、**
> **「EMA」で上質な滑らかさを加え、**
> **「デッドゾーン」で最後の1桁を安定させ、**
> **「静止平均積算」で止まった時に最高精度を叩き出す。**

この4段構えにより、建設現場の机水平調整において、業務用測定器に匹敵する使用感を実現する。
