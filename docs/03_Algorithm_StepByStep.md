# 高精度傾斜角センサー アルゴリズム詳細解説書（ステップバイステップ版）

更新日: 2026-02-15

## 1. はじめに

本書は、`02_TechnicalSpec.md` で定義された傾斜角推定アルゴリズムについて、具体的な数値を用いてその処理フローをステップバイステップで解説するものです。

### 前提シナリオ

- **状況**: センサー（スマホ）は **0.50度** の傾斜で静止しています。
- **ノイズ**: センサーには微小な電気的ノイズや振動があり、値は常に **±0.02度** 程度揺れ動いています。
- **キャリブレーション**: 設置時にズレがあり、**+0.05度** の補正が必要な状態とします（内部`calib = 0.05`）。

---

## 2. データ処理パイプライン

データは以下の順序で処理され、最終的な「表示値」となります。

`[Raw入力]` -> `[1.キャリブレーション]` -> `[2.カルマンフィルタ]` -> `[3.EMA]` -> `[4.デッドゾーン]` -> `[最終出力]`

---

## ステップ 1: Raw入力 (DeviceOrientation)

ブラウザの `deviceorientation` イベントから値が飛んできます。

- **時刻 T=1 の入力**: `0.57` (真値0.50 + ノイズ0.05 + 設置ズレ0.02)
  - ここでは少し大きめのノイズが乗って **0.57** という値が来たと仮定します。

---

## ステップ 2: キャリブレーション補正

保存された補正値（`calibPitch = 0.05`）を引きます。

- **計算式**: `Corrected = Raw - Calib`
- **計算**: `0.57 - 0.05 = 0.52`

> **状態**: 値は **0.52** になりました。真値(0.50)に近づきましたが、まだノイズ(0.02)が残っています。

---

## ステップ 3: 1次元カルマンフィルタ

ノイズ成分を除去し、最も確からしい値を推定します。

- **パラメータ**:
  - `Q` (プロセスの信頼度): 0.001 (急激な変化は少ないと仮定)
  - `R` (観測の信頼度): 0.1 (観測値はそれなりにノイズを含むと仮定)
  - `P` (現在の推定誤差分散): 適当な値から更新され続けます。

- **動作イメージ**:
  - 「前の推定値(0.50と仮定)」と「今の観測値(0.52)」を天秤にかけます。
  - `R` が `Q` に比べて大きいため、「観測値は信用できない（ノイズが多い）」と判断し、前の値を重視して、少しだけ観測値の方へ修正します。

- **計算（簡略化）**:
  - 前回の推定値: `0.50`
  - カルマンゲイン `K`: 計算の結果、例えば **0.1** 程度になったとします（観測値を10%だけ信用する）。
  - `NewEstimate = OldEstimate + K * (Observation - OldEstimate)`
  - `NewEstimate = 0.50 + 0.1 * (0.52 - 0.50)`
  - `NewEstimate = 0.50 + 0.002 = 0.502`

> **状態**: 値は **0.502** になりました。入力の `0.52` という大きなブレが、フィルタによって `0.502` まで抑え込まれました。

---

## ステップ 4: 指数移動平均 (EMA)

カルマンフィルタの出力をさらにマイルドにならします。過去の履歴を長く引きずるような処理です。

- **パラメータ**: `alpha = 0.08` (新しい値を8%しか採用しない。92%は過去の値を維持する)
- **計算式**: `EMA = alpha * Input + (1 - alpha) * OldEMA`

- **計算**:
  - 前回のEMA値: `0.500` と仮定
  - 入力（カルマン出力）: `0.502`
  - `EMA = 0.08 * 0.502 + 0.92 * 0.500`
  - `EMA = 0.04016 + 0.46000 = 0.50016`

> **状態**: 値は **0.50016** になりました。カルマンフィルタで取りきれなかった微小な変動も、さらに強力に平滑化されました。

---

## ステップ 5: デッドゾーン (Deadzone)

「静止しているのに数値がパラパラ変わる」のを防ぐため、変化量が一定以下の場合は「変化なし」とみなします。

- **パラメータ**: `threshold = 0.005`
- **判定**:
  - 現在の表示値: `0.500`
  - 新しいEMA値: `0.50016`
  - 差分: `|0.50016 - 0.500| = 0.00016`

- **ロジック**:
  - 差分 `0.00016` は しきい値 `0.005` より小さいか？
  - **YES** -> 更新しない。前の値を維持。

> **最終出力**: **0.500** （画面表示は変わらず）

---

## まとめ：もし大きな動きがあったら？

もしユーザーが実際にセンサーを傾けて、Raw値が **0.60** になった場合どうなるでしょうか？

1. **Catibration**: `0.60 - 0.05 = 0.55`
2. **Kalman**: 推定値が `0.51` くらいに上がる（まだ慎重）
3. **EMA**: 値が `0.505` くらいに上がる（さらに慎重）
4. **Deadzone**:
   - 差分 `|0.505 - 0.500| = 0.005`
   - しきい値以上なので、ここで初めて表示を更新！
   - **出力**: `0.505`

このように、**「微小なノイズは完全に無視」** しつつ、**「ある程度明確な動き（意図的な傾斜）」** は遅れて追従する、という挙動になります。これにより「ピタッと止まる」数値表示を実現しています。
