# 高精度傾斜角センサー アルゴリズム詳細解説書（ステップバイステップ版）

更新日: 2026-02-15

## 1. はじめに

本書は、`02_TechnicalSpec.md` で定義された傾斜角推定アルゴリズムについて、具体的な数値を用いてその処理フローをステップバイステップで解説する。

### 前提シナリオ

- **状況**: センサー（スマホ）は **0.50度** の傾斜で静止している。
- **ノイズ**: センサーには微小な電気的ノイズや振動があり、値は常に **±0.02度** 程度揺れ動いている。
- **キャリブレーション**: 設置時にズレがあり、**+0.05度** の補正が必要な状態である（内部`calib = 0.05`）。

---

## 2. データ処理パイプライン

データは以下の順序で処理され、最終的な「表示値」となる。

### Active Mode（通常時）

`[Raw入力]` → `[1.キャリブレーション]` → `[2.カルマンフィルタ]` → `[3.EMA]` → `[4.デッドゾーン]` → `[最終出力]`

### Static Mode（静止検出時）

`[Raw入力]` → `[1.キャリブレーション]` → `[2.カルマンフィルタ]` → `[5.静止平均積算]` → `[最終出力]`

---

## ステップ 1: Raw入力 (DeviceOrientation)

ブラウザの `deviceorientation` イベントから値が飛んでくる。

- **時刻 T=1 の入力**: `0.57` (真値0.50 + ノイズ0.02 + 設置ズレ0.05)
  - ここでは少し大きめのノイズが乗って **0.57** という値が来たと仮定する。

---

## ステップ 2: キャリブレーション補正

保存された補正値（`calibPitch = 0.05`）を引く。

- **計算式**: `Corrected = Raw - Calib`
- **計算**: `0.57 - 0.05 = 0.52`

> **状態**: 値は **0.52** になった。真値(0.50)に近づいたが、まだノイズ(0.02)が残っている。

---

## ステップ 3: 1次元カルマンフィルタ

ノイズ成分を除去し、最も確からしい値を推定する。

- **パラメータ**:
  - `Q` (プロセスの信頼度): 0.001（急激な変化は少ないと仮定）
  - `R` (観測の信頼度): 0.1（観測値はそれなりにノイズを含むと仮定）
  - `P` (現在の推定誤差分散): 適当な値から更新され続ける。

- **動作イメージ**:
  - 「前の推定値(0.50と仮定)」と「今の観測値(0.52)」を天秤にかける。
  - `R` が `Q` に比べて大きいため、「観測値は信用できない（ノイズが多い）」と判断し、前の値を重視して、少しだけ観測値の方へ修正する。

- **計算（簡略化）**:
  - 前回の推定値: `0.50`
  - カルマンゲイン `K`: 計算の結果、例えば **0.1** 程度になったとする（観測値を10%だけ信用する）。
  - `NewEstimate = OldEstimate + K * (Observation - OldEstimate)`
  - `NewEstimate = 0.50 + 0.1 * (0.52 - 0.50)`
  - `NewEstimate = 0.50 + 0.002 = 0.502`

> **状態**: 値は **0.502** になった。入力の `0.52` という大きなブレが、フィルタによって `0.502` まで抑え込まれた。

---

## ステップ 4: 指数移動平均 (EMA)【Active Mode のみ】

カルマンフィルタの出力をさらにマイルドにならす。過去の履歴を長く引きずるような処理である。

- **パラメータ**: `alpha = 0.08`（新しい値を8%しか採用しない。92%は過去の値を維持する）
- **計算式**: `EMA = alpha * Input + (1 - alpha) * OldEMA`

- **計算**:
  - 前回のEMA値: `0.500` と仮定
  - 入力（カルマン出力）: `0.502`
  - `EMA = 0.08 * 0.502 + 0.92 * 0.500`
  - `EMA = 0.04016 + 0.46000 = 0.50016`

> **状態**: 値は **0.50016** になった。カルマンフィルタで取りきれなかった微小な変動も、さらに強力に平滑化された。

---

## ステップ 5: デッドゾーン (Deadzone)【Active Mode のみ】

「静止しているのに数値がパラパラ変わる」のを防ぐため、変化量が一定以下の場合は「変化なし」とみなす。

- **パラメータ**: `threshold = 0.005`
- **判定**:
  - 現在の表示値: `0.500`
  - 新しいEMA値: `0.50016`
  - 差分: `|0.50016 - 0.500| = 0.00016`

- **ロジック**:
  - 差分 `0.00016` はしきい値 `0.005` より小さいか？
  - **YES** → 更新しない。前の値を維持する。

> **Active Mode 最終出力**: **0.500**（画面表示は変わらず）

---

## ステップ 6: 静止平均積算 (Static Average)【Static Mode】

システムが「静止している」と判定した場合、EMA・デッドゾーンの代わりにこの処理が適用される。

### 静止判定の仕組み

- 直近30フレーム（約0.5秒）の分散を計算する。
- 分散が閾値（例: 0.002）以下であれば「静止状態」と判定する。

### 計算例

静止と判定された後、カルマンフィルタの出力が以下のように蓄積されると仮定する。

| サンプル | カルマン出力 |
| :--- | :--- |
| 1 | 0.502 |
| 2 | 0.498 |
| 3 | 0.501 |
| 4 | 0.499 |
| 5 | 0.500 |
| ... | ... |
| 60 | 0.500 |

- **60サンプルの平均**: `0.5000`（ノイズが完全に相殺される）
- **理論**: サンプル数 $n=60$ で、ノイズの標準偏差は $\frac{\sigma}{\sqrt{60}} \approx 0.13 \sigma$ まで低減する。

> **Static Mode 最終出力**: **0.5000**（高精度でピタリと確定）

---

## まとめ：Active Mode vs Static Mode の挙動比較

| 状況 | Active Mode | Static Mode |
| :--- | :--- | :--- |
| ライナー調整中 | 「0.50 → 0.65 → 0.45」と機敏に追従 | 利用されない（分散が大きいため） |
| 机に置いて静止 | 「0.500」で安定表示 | 「0.5000」で超高精度表示 |
| 画面表示タイミング | 即時 | 約1〜2秒後に確定 |

**Active Mode** は「今どのくらい傾いているか」をリアルタイムに知るためのモードであり、**Static Mode** は「最終的に何度なのか」を正確に知るためのモードである。この自動切替により、建設現場での机水平調整に最適な操作感を実現する。
