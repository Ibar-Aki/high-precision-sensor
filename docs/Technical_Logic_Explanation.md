# 高精度傾斜角センサー 技術解説書
更新日: 2026-02-13

## 1. 本書の目的

本書は、傾斜角推定アルゴリズムの理論的背景および実装上の意図を明確化し、保守・改修時の技術判断基準を提供することを目的とする。

## 2. 観測モデル

DeviceOrientation API から取得される観測値を \( y_t \)、真値を \( x_t \)、観測ノイズを \( v_t \) とすると、観測は次式で表される。

\[
y_t = x_t + v_t
\]

本実装では、観測値から真値を推定するため、以下の3段処理を直列適用する。

1. 1次元カルマンフィルタ
2. 指数移動平均（EMA）
3. デッドゾーン処理

## 3. 1次元カルマンフィルタ

### 3.1 状態方程式

静的傾斜角計測を前提とし、状態遷移を次式で近似する。

\[
x_k = x_{k-1} + w_k, \quad w_k \sim N(0, Q)
\]

### 3.2 観測方程式

\[
z_k = x_k + v_k, \quad v_k \sim N(0, R)
\]

### 3.3 更新式

予測および更新は次式に従う。

\[
\hat{x}_k^- = \hat{x}_{k-1}
\]
\[
P_k^- = P_{k-1} + Q
\]
\[
K_k = \frac{P_k^-}{P_k^- + R}
\]
\[
\hat{x}_k = \hat{x}_k^- + K_k(z_k - \hat{x}_k^-)
\]
\[
P_k = (1 - K_k)P_k^-
\]

### 3.4 実装上のパラメータ

- \( Q = 0.001 \)
- \( R = 0.1 \)

上記値は「短時間で急変しない静的傾斜」を主用途とし、安定性を重視して設定している。

## 4. 指数移動平均（EMA）

カルマン推定値を \( u_t \)、EMA 出力を \( s_t \)、平滑化係数を \( \alpha \) とすると、次式となる。

\[
s_t = \alpha u_t + (1 - \alpha)s_{t-1}
\]

本実装の既定値は \( \alpha = 0.08 \) である。係数を小さくすると平滑化が強まり、追従性は低下する。

## 5. デッドゾーン処理

最終出力を \( o_t \)、EMA 出力を \( s_t \)、しきい値を \( \theta \) とする。

\[
o_t =
\begin{cases}
o_{t-1}, & |s_t - o_{t-1}| < \theta \\
s_t, & |s_t - o_{t-1}| \ge \theta
\end{cases}
\]

本実装の既定値は \( \theta = 0.005 \) である。これにより、静止時の微小揺らぎを表示上で抑制する。

## 6. パイプライン全体

\[
\text{Raw} \rightarrow \text{Kalman} \rightarrow \text{EMA} \rightarrow \text{Deadzone} \rightarrow \text{Output}
\]

上記処理を継続適用することで、観測値の過度なばらつきを抑え、実用上有効な安定表示を実現する。

## 7. 運用上の留意事項

- 絶対精度は端末個体差および設置条件に依存する。
- 高精度運用時は、計測対象面でのキャリブレーション実施を前提とする。
- 設定値変更時は、応答性と安定性のトレードオフを考慮して調整する。
