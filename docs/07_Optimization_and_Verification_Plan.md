# 建設現場向けパラメータ調整方針および検証計画書

更新日: 2026-02-15

## 1. はじめに

建設現場という制御不能な外乱（重機振動、足音、風など）が存在する環境下において、提案した「静止平均積算（Static Average）」を最適に動作させるための指針および検証手順書です。

---

## 2. パラメータ調整の基本的考え方

「静止モード」に入るための条件と、入った後の挙動について、**「誤検出のリスク」と「計測時間」のトレードオフ** を調整します。

### A. 静止判定閾値 (Threshold)

- **意味**: 「どれくらいの揺れまでなら『静止』とみなすか」
- **現場課題**:
  - **低すぎる（敏感）**: 少しの風や近くの足音でロックが解除され、いつまでも計測完了しない。
  - **高すぎる（鈍感）**: ユーザーが手で持っているのに「静止」と誤判定し、デタラメな値をロックしてしまう。
- **調整方針**:
  - デフォルト値は「机に置いた状態のノイズ分散の2〜3倍」に設定。
  - 現場で計測対象（机）に環境振動がどれくらい乗っているかを測定し、そのベースラインよりも少し高く設定する。

### B. 静止持続時間 (Duration)

- **意味**: 「静止状態が何秒続いたらロック（平均化開始）するか」
- **現場課題**:
  - **短すぎる**: 偶発的に一瞬揺れが止まったタイミングで誤ロックする。
  - **長すぎる**: ユーザーの待ち時間が長くなり、ストレスになる。作業効率が落ちる。
- **調整方針**:
  - 建設現場では突発的な衝撃（ハンマー打撃など）があるため、**最低でも0.5秒〜1.0秒** の持続時間を設ける。
  - 1秒間安定していれば、それは「意図的に置かれた」状態である確率が高い。

### C. 平均化バッファサイズ (Buffer Size)

- **意味**: 「過去何秒分のデータを使って平均値を出すか」
- **現場課題**:
  - **少ない**: バラつきが収束しきらず、最後の1桁が確定しない。
  - **多い**: 収束は綺麗だが、過去の（置き始めの不安定な）データを引きずり、最終値が出るまでに時間がかかる。
- **調整方針**:
  - **リセット方式**を採用する。「静止」と判定された瞬間にバッファを空にし、そこから溜め始めることで、動いていた頃のデータを完全に排除する。
  - 目標精度（±0.001度）に達するために必要なサンプル数を計算し、それを満たしたら「完了」とする。

---

## 3. 実地検証（フィールドテスト）用 TODOリスト

開発室やオフィスでのテストではなく、**実際の現場環境** で行うべき手順です。

### [Step 1] 環境ノイズの測定（データロギング）

まず「敵（外乱）」を知る必要があります。

- [ ] **診断アプリの用意**: 現在の生の分散値（Variance）を数値でリアルタイム表示するデバッグモードを実装する。
- [ ] **静置測定**: 実際の現場の机の上にセンサーを置き、誰も触れない状態で30秒間ログを取る。
  - *チェック項目*: 周囲で作業が行われている時の分散の最大値はいくらか？
- [ ] **作業中測定**: 机の脚を調整（ライナー抜き差し）している最中の分散値を取る。
  - *チェック項目*: 「調整中」と「静置中」の分散値の差（S/N比）は十分にあるか？

### [Step 2] 閾値の決定（チューニング）

測定結果に基づき、パラメータを仮決めします。

- [ ] **静止判定閾値の設定**:
  - 論理式: `Threshold = (環境ノイズの最大分散) * 1.5`
  - 環境ノイズが `0.005` なら `0.0075` 程度に設定。これ以下なら「静止」とみなす。
- [ ] **誤検知テスト**: 手に持った状態で、極力動かないように我慢してみる。
  - *Golden Rule*: 人間が頑張って止めてもロックされない（Thresholdを超え続ける）レベルが理想。机に置いた時だけロックされるのが正解。

### [Step 3] 運用テストとUX確認

実際に作業者が使いやすいかを確認します。

- [ ] **応答時間テスト**: 机に置いてから「計測完了」が出るまでの時間を計測。
  - 目標: **2秒以内**。3秒を超えると作業者は「遅い」と感じてイライラし始める。
- [ ] **外乱ロバスト性テスト**: 計測中に近くを人が歩いたり、遠くで重機が動いたりしても、ロックが外れたり値が飛び跳ねたりしないか確認。
- [ ] **復帰テスト**: 机をコンコンと叩いた瞬間にロックが解除され、再計測待ちになるか（感度が悪すぎてフリーズしていないか）。

### [Step 4] 最終精度確認

- [ ] **比較計測**: 既存の高級水準器（気泡管やデジタルプロトラクター）と並べて計測し、静止平均後の値が一致（またはより高安定）しているか確認。

---

## 4. 開発側へのフィードバック項目

現場検証の結果、以下の項目の調整が必要になる可能性があります。事前に設定画面で変更可能にしておくことを推奨します。

| パラメータ名 | 設定画面ラベル案 | デフォルト値 |
| :--- | :--- | :--- |
| `staticVarianceThreshold` | 感度（振動許容値） | `0.002` (要調整) |
| `staticDurationFrame` | 判定時間（ウェイト） | `30` frames (0.5s) |
| `averagingSampleCount` | 精度（サンプル数） | `60` frames (1.0s) |
