# 高精度・静止計測ハイブリッドアルゴリズム設計書

更新日: 2026-02-15

## 1. 背景と目的

「4本足の机の高さ調整」というユースケースには、下記の特徴がある。

1. **調整時（動）**: ライナーを抜き差しする際は、センサーが持ち上げられたり振動したりする。
2. **計測時（静）**: 調整後、センサーを置いて手を離し、数値を読み取る。この時間は「完全な静止」が期待できる。
3. **要求**: 静止時には、現状（±0.01度程度の揺らぎ）よりもさらに高い精度（確度）が欲しい。
4. **環境**: 建設現場であり、重機振動・足音・風などの外乱が常に存在する可能性がある。

これに対し、**施策C（静止判定型平均 / Latch & Average）** を現行アルゴリズムに統合し、**「動いているときは素早く反応し、止まったら超高精度になる」** ハイブリッドシステムを設計した。

---

## 2. アルゴリズム設計

### 概要

システムは常に「動きの分散（ばらつき）」を監視し、自動的にモードを切り替える。

| モード名 | 状態 | 適用アルゴリズム | 特徴 |
| :--- | :--- | :--- | :--- |
| **Active Mode** | 調整中・移動中 | **現状維持** (Kalman + EMA + Deadzone) | 応答性重視。通常の動きに追従する。 |
| **Static Mode** | 完全静止中 | **施策C** (Signal Accumulation) | 精度重視。止まっている間のデータを全て平均し、真値に収束させる。 |

### 処理フロー詳細

初期状態: **Active Mode**

1. **入力**: `deviceorientation` から生データを取得する。
2. **静止監視**: 直近 $N$ フレーム（例: 30フレーム/約0.5秒）の分散を計算する。
    - 分散 > 閾値 →「動きあり」と判定する。
        - **Active Mode** を継続する。通常通り Kalman + EMA の値を出力する。
        - Static Mode用の蓄積バッファをリセットする。
    - 分散 <= 閾値 →「静止」と判定する。
        - **Static Mode** へ移行（または継続）する。
3. **Static Mode 処理**:
    - 現在のカルマンフィルタ通過後の値を、蓄積バッファに追加する。
    - バッファ内の**全データの平均値**を出力とする。
    - サンプル数が増えるほど、ノイズ成分 $v$ は $\frac{1}{\sqrt{n}}$ で減衰し、限りなく真値に近づく。

---

## 3. 期待される挙動（ユーザー体験）

1. **設置（調整中）**:
    - 数値は「0.50 → 0.65 → 0.45」のように機敏に動く。
2. **手を離す（静止開始）**:
    - 数値の変動が減る。
    - 画面上に **「LOCKING...」** や **「MEASURING」** といったインジケータが出る（UI提案）。
3. **静止確定（約1〜2秒後）**:
    - 数値が **「0.453」** のように、普段より1桁多い精度でピタリと止まる。
    - 背景色が変わり「測定完了」を伝える。
4. **再調整（接触）**:
    - 机に触れて振動が伝わった瞬間、ロックが外れ、再び **Active Mode**（通常のリアルタイム表示）に戻る。

---

## 4. 実装パラメータ

| パラメータ名 | 説明 | デフォルト値 | 備考 |
| :--- | :--- | :--- | :--- |
| `staticVarianceThreshold` | 静止判定閾値 | `0.002` | 現場の環境振動に合わせて要調整 |
| `staticDurationFrame` | 静止持続判定フレーム数 | `30` (約0.5秒) | 短すぎると誤ロック、長すぎると待ち時間増 |
| `averagingSampleCount` | 平均化サンプル数 | `60` (約1.0秒) | 多いほど高精度だが確定が遅くなる |
| `maxBufferSize` | 最大蓄積数 | `2000` | 長時間放置のドリフト対策 |

---

## 5. 建設現場への対応（検討事項）

- **微振動の影響**: 工場内などで床自体が微振動している場合、永遠に「静止」と判定されない可能性がある。
  - *対策*: 閾値を設定画面で「高感度 / 標準 / 低感度」から選べるようにする。
- **ドリフト**: ジャイロセンサーは長時間経つと温度等でドリフトする。
  - *対策*: 完全な単純平均ではなく、非常に長い期間（例: 5秒）の移動平均にするか、古いデータを捨てていく「スライディングウィンドウ型」にする。
- **パラメータ調整の詳細**: `design/DS-05_Optimization_and_Verification_Plan.md` に調整方法と検証手順を記載した。

---

## 6. 結論

本施策は「建設現場での机水平調整」というユースケースにおいて**極めて有効**である。
実装コストも低く、既存の `SensorEngine` クラスに「静止判定ロジック」と「平均化バッファ」を追加するのみで実現可能である。
