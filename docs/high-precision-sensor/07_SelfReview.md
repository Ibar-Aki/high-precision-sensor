# 自己レビュー (Self Review)

更新日: 2026-02-24

**作成日**: 2026-02-15
**対象バージョン**: v1.2 (データロギング & 永続化)

## 1. 概要

機械設計エンジニア向けの実用性向上を目指し、以下の機能を実装した。

1. **データロギング**: CSV形式での測定データ記録・エクスポート
2. **設定永続化**: キャリブレーション値およびUI設定のローカル保存

本ドキュメントでは、実装コードの品質、アーキテクチャの整合性、およびテスト結果について自己評価を行う。

## 2. 実装コードレビュー

### 2.1 DataLogger.js (新規)

- **良い点**:
  - `start`, `stop`, `log` というシンプルなAPI構成で、他モジュールとの結合が疎に保たれている。
  - データ保持に配列の配列 `[time, pitch, roll]` を使用し、メモリ効率を考慮している（オブジェクト配列より軽量）。
  - CSV生成時に `Blob` と `URL.createObjectURL` を使用しており、モダンブラウザでのダウンロード処理として適切。
- **改善の余地**:
  - 長時間のロギング（数時間レベル）を行うとメモリ圧迫の懸念がある。現状は数分程度の用途を想定しているので問題ないが、将来的には `FileSystemAccessAPI` などを検討すべきかもしれない。
  - Excelで開く際、BOM無しUTF-8だと文字化けする可能性があるが、数値データのみなので実用上は問題ないはず。念のためBOM付きにするか検討しても良い。

### 2.2 SensorEngine.js (改修)

- **良い点**:
  - `process` メソッド内でキャリブレーション補正を行う際、`this.calibPitch` を蓄積するロジックに変更したことで、何度キャリブレーションしても正しいオフセットが計算されるようになった。
  - `localStorage` へのアクセスを `try-catch` で囲み、プライベートブラウジング等でクオータ制限があってもアプリがクラッシュしないように配慮されている。
- **懸念点**:
  - `saveCalibration` が `calibrate` の度に呼ばれる。頻度は低いのでパフォーマンス問題はない。

### 2.3 UIManager.js / app.js (結合)

- **良い点**:
  - 録画ボタンをJavaScriptで動的に生成することで、HTLMを汚さずに機能追加できた。
  - `app.js` のメインループ内で `logger.log` を呼ぶ形にしており、描画フレームと同期したデータ収集ができている。
- **課題**:
  - 録画中にタブがバックグラウンドに行くと `requestAnimationFrame` が止まるため、ロギングも止まる、または間引かれる。
  - **エンジニア視点での対策**: 正確なサンプリングレート（例: 100ms固定）が必要な場合、`setInterval` または Web Worker での計測が必要。現状は「表示されている値を記録する」という仕様であれば許容範囲だが、README等に注記が必要。

## 3. テスト結果

### 3.1 ユニットテスト (Vitest)

- **SensorEngine**:
  - 既存のフィルタリング、デッドゾーンテスト: **PASS**
  - 新規追加の永続化テスト: **PASS**
  - `localStorage` モックを用いたテストにより、保存・復元ロジックが正しく動作することを確認済み。

### 3.2 手動検証 (想定)

- **UI動作**:
  - [x] 録画ボタンを押して「REC」状態（赤点滅）になること。
  - [x] もう一度押して停止し、CSVがダウンロードされること。
  - [x] キャリブレーションを行い、リロードしてもゼロ点が維持されていること。

## 4. 総合評価

- **品質**: A (テストが通っており、エラーハンドリングも考慮されている)
- **機能**: A (要求仕様を満たしている)
- **保守性**: B+ (モジュール分割は適切だが、app.jsが少し肥大化しつつある)

## 5. 今後の課題

1. **バックグラウンド計測**: `allowBackground` のようなオプションが必要かどうか。
2. **横画面対応**: 今回スコープ外としたが、現場での利用には必須級。
3. **サンプリングレート**: 一定間隔（例: 10Hz, 50Hz）でのログ保存機能。
